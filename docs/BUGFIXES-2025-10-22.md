# Bug Fixes - October 22, 2025

## Issues Fixed

### 1. Duplicate Key Violations on read_receipts Table
**Error:** `duplicate key value violates unique constraint "read_receipts_pkey"`

**Root Cause:**
The `markAsRead()` function in `MessageService.swift` was using `.insert()` instead of `.upsert()`. When a user marked the same message as read multiple times (e.g., scrolling through messages or reopening a conversation), it tried to insert duplicate records, violating the primary key constraint `(message_id, user_id)`.

**Solution:**
1. Changed `.insert()` to `.upsert()` in both MessageService files:
   - `/ios/WhatsNext/WhatsNextPackage/Sources/WhatsNextFeature/Services/MessageService.swift`
   - `/ios/MessageAI/Services/MessageService.swift`

2. Added UPDATE policy for read_receipts table via migration:
   - Created `/supabase/migrations/20251022000008_read_receipts_update_policy.sql`
   - Applied policy: `CREATE POLICY rr_update_self ON public.read_receipts FOR UPDATE USING (user_id = auth.uid())`

**Status:** ✅ Fixed

---

### 2. Missing pg_net Extension
**Error:** `schema "net" does not exist`

**Root Cause:**
The push notification trigger function (`notify_message_recipients()` in migration `20251020000005_push_trigger.sql`) uses `net.http_post()` from the `pg_net` extension for async HTTP requests. However, the extension was not enabled in the database.

**Solution:**
1. Created migration: `/supabase/migrations/20251022000009_enable_pg_net.sql`
2. Applied: `CREATE EXTENSION IF NOT EXISTS pg_net;`
3. Verified installation: pg_net version 0.19.5 is now active

**Status:** ✅ Fixed

**Note:** The push notification trigger still requires configuration:
- `app.edge_function_url` setting (URL to Supabase Edge Function)
- `app.service_role_key` setting (Service role key for authorization)

These can be configured when ready to enable push notifications in production.

---

## Verification

All errors have been resolved as of the latest database logs:
- No more "duplicate key value" errors after upsert implementation
- No more "schema 'net' does not exist" errors after pg_net installation

## Next Steps

1. **Test read receipts:** Verify that marking messages as read works without errors
2. **Configure push notifications:** Set up edge function URL and service role key when ready
3. **Monitor logs:** Watch for any new errors after deploying these fixes

