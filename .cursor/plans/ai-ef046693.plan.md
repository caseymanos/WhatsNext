<!-- ef046693-c00e-4a0f-8b44-3064bf27934a 7ba5ca94-04f2-4f56-b1e7-c15859893713 -->
# AI Integration and Separation Plan

## Goals

- Stabilize main app: AI off by default, no compile/runtime impact.
- Merge and deploy backend: `extract-calendar-events` Edge Function.
- Integrate AI features in iOS with a gated scheme + runtime toggle.
- Add tests and docs; provide clear verification steps.

## 1) Feature-Flag Separation (iOS)

- Add compilation condition `AI_FEATURES` in build settings.
  - Update `ios/WhatsNext/Config/Debug.xcconfig`/`Release.xcconfig` to not define it.
  - Create an “AI Debug” scheme that defines `SWIFT_ACTIVE_COMPILATION_CONDITIONS += AI_FEATURES`.
- Guard AI code with compile flags:
  - Wrap `Sources/WhatsNextFeature/AI/**` entry points (views/services) with `#if AI_FEATURES ... #endif`.
  - Example snippet:
    ```swift
    #if AI_FEATURES
    public init(aiService: AIServiceProtocol = SupabaseAIService()) {}
    #else
    public init(aiService: AIServiceProtocol = MockAIService()) {}
    #endif
    ```

- Runtime toggle:
  - Add `DebugSettings.aiEnabled` (backed by UserDefaults) and show the AI tab only when both `AI_FEATURES && aiEnabled`.
  - Gate the Tab: `if debugSettings.aiEnabled { AITabView(...) }`.
- Ensure non-AI targets compile: exclude AI-only files or guard imports to remove warnings.

## 2) Fix/Align iOS AI Service Contracts

- Confirm `SupabaseAIService` invocation shape using supabase-swift v2 functions:
  - Use `invoke("extract-calendar-events", options: .init(body: payload))` decoding directly to `ResponseBody`.
- Ensure models align with Edge Function response: `events: [CalendarEvent]`.
- Keep `MockAIService` as fallback for local/dev when AI is off.

## 3) Backend PR Merge + Deploy

- Review the pending backend PR:
  - Edge Function `supabase/functions/extract-calendar-events/index.ts` (or Deno entry) conforms to `RequestBody` and returns `{ events: CalendarEvent[] }`.
  - Add secrets for provider (e.g., `OPENAI_API_KEY`) with `supabase secrets set`.
  - Validate JWT: require authenticated user; enforce input validation; rate limit if available.
- Deploy sequence:
  - `supabase functions deploy extract-calendar-events`
  - If new SQL required, add migration under `supabase/migrations/` and run `supabase db push`.
  - Verify with `supabase functions logs extract-calendar-events`.

## 4) iOS Wiring & UI Integration

- Inject service in `AIViewModel` and `AITabView` using DI defaulting per flag (see snippet above).
- Conversation selection already present; ensure `Conversation` mapping uses existing models.
- Insight badges on list:
  - Expose a lightweight `AIInsightsCache` query for counts; only show the badge when count > 0.
  - Keep badge code optional-parameter based, so non-AI builds ignore.
- Add error and offline handling to show fallback messages when function is unavailable.

## 5) Tests

- Unit tests: `AI/Services` and `AI/Models` with `MockAIService`.
- Feature-flag tests: verify AI tab hidden when `AI_FEATURES` off and visible when on.
- Integration test (optional, nightly): call Edge Function with a test conversation.

## 6) Documentation & Ops

- Update `docs/CHANGELOG.md` and `docs/Core-Backlog-Progress.md` with AI gating and backend deploy steps.
- Add a short “AI Setup” section in `PUSH_NOTIFICATIONS_SETUP.md` or a new subsection in existing docs covering:
  - Secrets, deployment, and environment requirements.
  - How to enable the AI scheme and runtime toggle.

## 7) Verification

- Simulator: AI off by default → no AI tab; app builds and runs.
- AI Debug scheme: enable runtime toggle → AI tab visible; run analysis on selected conversations.
- Device: same flows; verify function call and response render.
- Conversation list shows sparkles badge only when insights exist.

### To-dos

- [x] Add AI_FEATURES compilation condition and AI Debug scheme
- [x] Gate AI tab behind compile flag + runtime toggle
- [x] Wrap AI sources with #if AI_FEATURES to ensure clean non-AI builds
- [x] Align SupabaseAIService invoke/response to Edge Function contract
- [x] Inject AI service into AIViewModel/AITabView based on flag
- [ ] Verify on sims and device with and without AI enabled